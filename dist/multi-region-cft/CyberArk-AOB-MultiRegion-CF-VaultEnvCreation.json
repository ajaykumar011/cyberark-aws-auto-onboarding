{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Resources": {
        "CreateSafe": {
            "Type": "AWS::CloudFormation::CustomResource",
            "Version": "1.0",
            "Properties": {
                "ServiceToken": {
                    "Ref": "SafeHandlerLambdaARN"
                },
				"PVWAIP": {
					"Ref": "PvwaIP"
				},
				"UnixSafeName": {
					"Ref": "UnixSafeName"
				},
				"WindowsSafeName": {
					"Ref": "WindowsSafeName"
				},
				"Username": {
					"Ref": "VaultUser"
				},
				"Password": {
					"Ref": "VaultPassword"
				},
    			"CPMUnix": {
					"Ref": "CPMNameUnixSafe"
				},
				"CPMWindows": {
					"Ref": "CPMNameWindowsSafe"
				},
				"KeyPairSafe": {
					"Ref": "KeyPairsSafe"
				},
				"KeyPairName": {
					"Ref": "KeyPairName"
				},
				"AWSRegionName": {
					"Ref": "AWS::Region"
				},
				"AWSAccountId": {
					"Ref": "AWS::AccountId"
				},
				"PVWAPublicKeyFileName":{
					"Ref": "PVWAPublicKeyFileName"
				},
				"LaMbdasbUcket":{
				    "Ref": "LaMbdasbUcket"
				}
            },
			"CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT2M"
                }
            }
        },
        "ParameterPVWA": {
			"Type" : "AWS::SSM::Parameter",
			"Properties" : {
				"Name" : "PVWA_IP",
				"Description" : "The IP of the PVWA",
				"Type" : "String",
				"Value" : {"Ref": "PvwaIP"}
			}
		},
		"ParameterUnixAccountsSafe": {
			"Type" : "AWS::SSM::Parameter",
			"Properties" : {
				"Name" : "Unix_Safe_Name",
				"Description" : "Safe name for UNIX accounts",
				"Type" : "String",
				"Value" : {"Ref": "UnixSafeName"}
			}
		},
		"ParameterWindowsAccountsSafe": {
			"Type" : "AWS::SSM::Parameter",
			"Properties" : {
				"Name" : "Windows_Safe_Name",
				"Description" : "Safe name for Windows accounts",
				"Type" : "String",
				"Value" : {"Ref": "WindowsSafeName"}
			}
		},
		"ParameterUsername": {
			"Type" : "AWS::SSM::Parameter",
			"Properties" : {
				"Name" : "Vault_User",
				"Type" : "String",
				"Value" : {"Ref": "VaultUser"}
			}
		},
		"ParameterAWSKeyPairSafe": {
			"Type" : "AWS::SSM::Parameter",
			"Properties" : {
				"Name" : "KeyPair_Safe",
				"Description" : "Safe where all the AWS KeyPair are stored",
				"Type" : "String",
				"Value" : {"Ref": "KeyPairsSafe"}
			}
		}
	},
	"Parameters": {
	    "SafeHandlerLambdaARN": {
	        "Type": "String",
	        "Description": "ARN of SafeHandlerLambda. An output of first CloudFormation Templates"
	    },
		"LaMbdasbUcket": {
            "Type": "String",
            "Description": "The S3 Bucket where the PVWA PublicKey resides"
        },
		"PvwaIP": {
			"Type": "String",
            "Description": "PVWA IP address or host name",
			"MinLength": "1"
		},
		"PVWAPublicKeyFileName": {
			"Type": "String",
            "Description": "The name of the file in S3 Bucket that contains PVwA PublicKey.",
			"MinLength": "1"
		},
		"UnixSafeName": {
			"Type": "String",
            "Description": "Name of the Safe that will store all the Unix accounts created by the solution. The deployment will fail if the safe already exist.",
			"AllowedPattern": "^[^\\\\:\\*<>\\\"\\.\\|\\\/]*$",
			"MinLength": "1",
			"MaxLength": "28"
		},
		"WindowsSafeName": {
			"Type": "String",
            "Description": "Name of the Safe that will store all the Windows accounts created by the solution. The deployment will fail if the safe already exist.",
			"AllowedPattern": "^[^\\\\:\\*<>\\\"\\.\\|\\\/]*$",
			"MinLength": "1",
			"MaxLength": "28"
		},
		"VaultUser": {
			"Type": "String",
            "Description": "Vault user that will be used by the solution.",
			"MinLength": "1"
		},
		"VaultPassword": {
			"Type": "String",
            "Description": "Password of the Vault user.",
			"NoEcho": true,
			"MinLength": "1"
		},
		"CPMNameUnixSafe": {
			"Type": "String",
            "Description": "Name of the CPM manager to manage Unix Accounts Safe",
			"MinLength": "1",
			"Default": "PasswordManager"
		},
		"CPMNameWindowsSafe": {
			"Type": "String",
            "Description": "Name of the CPM manager to manage Windows Accounts Safe",
			"MinLength": "1",
			"Default": "PasswordManager"
		},
		"KeyPairsSafe": {
            "Type": "String",
            "Description": "Name of the Safe that will store all Key Pairs used by the solution. The deployment will fail if the safe already exist.",
			"AllowedPattern": "^[^\\\\:\\*<>\\\"\\.\\|\\\/]*$",
			"MinLength": "1",
			"MaxLength": "28"
        },
		"KeyPairName": {
            "Type": "String",
            "Description": "Name of the Key pair",
			"MaxLength": "255"
        }
	},
	"Metadata":{
	    "AWS::CloudFormation::Interface":{
	        "ParameterGroups": [
	                {
    					"Label": {
    						"default": "General parameters"
    					},
                        "Parameters": [
                            "SafeHandlerLambdaARN",
    						"PvwaIP",
    						"LaMbdasbUcket",
                            "PVWAPublicKeyFileName",
    						"VaultUser",
    						"VaultPassword",
    						"UnixSafeName",
    						"CPMNameUnixSafe",
    						"WindowsSafeName",
    						"CPMNameWindowsSafe",
    						"KeyPairsSafe"
                        ]
                    },
                    {
    					"Label": {
    						"default": "Optional: Create new KeyPair for the solution:"
    					},
                        "Parameters": [
    						"KeyPairName"
                        ]
                    }
	            ],
	        "ParameterLabels": {
	                "SafeHandlerLambdaARN": {
	                    "default": "ARN of SafeHandlerLambda. An output of first CloudFormation Templates"
	                },
	                "LaMbdasbUcket": {
	                    "default": "The S3 Bucket where the PVWA PublicKey resides"
	                },
	                "PvwaIP": {
                        "default": "PVWA IP/Host Name:"
                    },
                    "PVWAPublicKeyFileName": {
                    	"default": "PVWA PublicKey file name within s3 Bucket"
                    },
    				"UnixSafeName": {
                        "default": "Target Safe for Unix accounts:"
                    },
                    "WindowsSafeName": {
                        "default": "Target Safe for Windows accounts:"
                    },
    				"VaultUser": {
                        "default": "Vault user name:"
                    },
    				"VaultPassword": {
                        "default": "Vault password:"
                    },
    				"CPMNameUnixSafe": {
    					"default": "CPM name for managing Unix safe:"
    				},
    				"CPMNameWindowsSafe": {
    					"default": "CPM name for managing Windows safe:"
    				},
    				"KeyPairsSafe": {
    					"default": "Target Safe for the Key pairs:"
    				},
    				"KeyPairName": {
    					"default": "Key Pair name:"
    				}
	        }
	    }
	}
}